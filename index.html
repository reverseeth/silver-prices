<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Silver Premium | Shanghai vs COMEX</title>
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --black: #000000;
      --g1: #080808;
      --g2: #0e0e0e;
      --g3: #161616;
      --g4: #1e1e1e;
      --g5: #282828;
      --g6: #555555;
      --g7: #777777;
      --g8: #999999;
      --g9: #bbbbbb;
      --g10: #d4d4d4;
      --g11: #eaeaea;
      --white: #f5f5f5;
      --green: #22c55e;
      --green-soft: rgba(34,197,94,0.07);
      --green-glow: rgba(34,197,94,0.14);
      --red: #ef4444;
      --red-soft: rgba(239,68,68,0.07);
      --red-glow: rgba(239,68,68,0.14);
      --amber: #eab308;
      --amber-soft: rgba(234,179,8,0.07);
      --amber-glow: rgba(234,179,8,0.14);
    }

    html {
      font-size: 16px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    body {
      font-family: 'Helvetica Neue', 'Helvetica', 'Arial', sans-serif;
      font-variant-numeric: tabular-nums;
      background: var(--black);
      color: var(--g10);
      min-height: 100vh;
      overflow-x: hidden;
    }

    .page { max-width: 880px; margin: 0 auto; padding: 0 28px 72px; }

    /* ============================================================
       HEADER
       ============================================================ */
    .header {
      padding: 52px 0 0;
      display: flex; align-items: center; justify-content: space-between;
      opacity: 0; animation: rise .7s cubic-bezier(.16,1,.3,1) forwards;
    }

    .brand { display: flex; align-items: center; gap: 14px; }

    .brand-mark {
      width: 32px; height: 32px; border-radius: 9px;
      background: var(--g2); border: 1px solid var(--g4);
      display: grid; place-items: center;
      font-size: 0.8125rem; font-weight: 600; color: var(--g8);
      letter-spacing: -0.02em;
    }

    .brand-text {
      font-size: 1rem; font-weight: 500; color: var(--white);
      letter-spacing: -0.025em;
    }

    .header-time {
      font-size: 0.8125rem; color: var(--g6);
      letter-spacing: -0.01em;
    }

    /* ============================================================
       PREMIUM HERO
       ============================================================ */
    .hero {
      margin: 48px 0;
      padding: 56px 44px 52px;
      background: var(--g1);
      border: 1px solid var(--g3);
      border-radius: 22px;
      text-align: center;
      position: relative;
      overflow: hidden;
      opacity: 0; animation: rise .7s cubic-bezier(.16,1,.3,1) .08s forwards;
    }

    .hero::before {
      content: '';
      position: absolute; top: 0; left: 50%; transform: translateX(-50%);
      width: 35%; height: 1px;
      background: linear-gradient(90deg, transparent, var(--g5), transparent);
    }

    .hero-glow {
      position: absolute; top: -50px; left: 50%; transform: translateX(-50%);
      width: 320px; height: 160px;
      background: radial-gradient(ellipse, var(--green-soft) 0%, transparent 70%);
      pointer-events: none;
      transition: opacity .6s ease;
      opacity: 0;
    }

    .hero-glow.pos {
      background: radial-gradient(ellipse, var(--green-soft) 0%, transparent 70%);
      opacity: 1;
    }

    .hero-glow.neg {
      background: radial-gradient(ellipse, var(--red-soft) 0%, transparent 70%);
      opacity: 1;
    }

    .hero-icon {
      position: relative; z-index: 1;
      display: inline-flex; align-items: center; justify-content: center;
      width: 50px; height: 50px; border-radius: 15px;
      background: var(--g2); border: 1px solid var(--g4);
      color: var(--g7); margin-bottom: 26px;
      transition: border-color .4s, color .4s;
    }

    .hero-icon svg { width: 22px; height: 22px; }
    .hero-icon.ok { border-color: var(--g5); color: var(--g8); }

    .hero-label {
      position: relative; z-index: 1;
      font-size: 0.8125rem; font-weight: 500; color: var(--g6);
      letter-spacing: 0.12em; text-transform: uppercase;
      margin-bottom: 22px;
    }

    .hero-value {
      position: relative; z-index: 1;
      font-size: 5rem; font-weight: 700;
      letter-spacing: -0.05em; line-height: 1;
      transition: color .4s ease;
    }

    .hero-value.pos { color: var(--green); }
    .hero-value.neg { color: var(--red); }
    .hero-value.nil { color: var(--g4); }

    .hero-sub {
      position: relative; z-index: 1;
      margin-top: 18px;
      font-size: 1.0625rem; font-weight: 400; color: var(--g6);
      letter-spacing: -0.01em;
    }

    .hero-sub strong { font-weight: 600; color: var(--g9); }

    .hero-note {
      position: relative; z-index: 1;
      margin-top: 28px;
      font-size: 0.8125rem; font-weight: 400; color: var(--g6);
      letter-spacing: -0.005em;
    }

    /* ============================================================
       CARDS
       ============================================================ */
    .cards {
      display: grid; grid-template-columns: 1fr 1fr; gap: 16px;
      opacity: 0; animation: rise .7s cubic-bezier(.16,1,.3,1) .16s forwards;
    }

    .card {
      background: var(--g1);
      border: 1px solid var(--g3);
      border-radius: 20px;
      overflow: hidden;
      position: relative;
      transition: border-color .3s ease, transform .35s cubic-bezier(.16,1,.3,1);
    }

    .card::before {
      content: '';
      position: absolute; top: 0; left: 50%; transform: translateX(-50%);
      width: 30%; height: 1px;
      background: linear-gradient(90deg, transparent, var(--g4), transparent);
      opacity: 0; transition: opacity .3s ease;
    }

    .card:hover {
      border-color: var(--g4);
      transform: translateY(-3px);
    }

    .card:hover::before { opacity: 1; }

    .card-inner { padding: 30px 30px 34px; }

    .card-top {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 30px;
    }

    .card-id { display: flex; align-items: center; gap: 14px; }

    .card-icon {
      width: 42px; height: 42px; border-radius: 13px;
      background: var(--g2); border: 1px solid var(--g4);
      display: grid; place-items: center; color: var(--g7);
      transition: border-color .3s, color .3s;
    }

    .card:hover .card-icon { border-color: var(--g5); color: var(--g8); }
    .card-icon svg { width: 18px; height: 18px; }

    .card-title {
      font-size: 1.0625rem; font-weight: 500; color: var(--g11);
      letter-spacing: -0.025em;
    }

    .card-subtitle {
      font-size: 0.8125rem; font-weight: 400; color: var(--g6);
      margin-top: 3px; letter-spacing: -0.005em;
    }

    /* Badges */
    .badge {
      font-size: 0.6875rem; font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.04em;
      padding: 5px 11px; border-radius: 9px;
      display: inline-flex; align-items: center; gap: 7px;
    }

    .badge-dot { width: 5px; height: 5px; border-radius: 50%; }

    .badge-live {
      color: var(--green); background: var(--green-soft);
      border: 1px solid var(--green-glow);
    }

    .badge-live .badge-dot {
      background: var(--green);
      box-shadow: 0 0 6px var(--green-glow);
      animation: blink 2s ease-in-out infinite;
    }

    .badge-delayed {
      color: var(--amber); background: var(--amber-soft);
      border: 1px solid var(--amber-glow);
    }

    .badge-delayed .badge-dot {
      background: var(--amber);
      box-shadow: 0 0 6px var(--amber-glow);
      animation: blink-slow 3s ease-in-out infinite;
    }

    @keyframes blink {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.12; transform: scale(0.75); }
    }

    @keyframes blink-slow {
      0%, 100% { opacity: 0.9; transform: scale(1); }
      50% { opacity: 0.12; transform: scale(0.75); }
    }

    /* Price */
    .price-row { display: flex; align-items: baseline; gap: 10px; }

    .price-num {
      font-size: 2.75rem; font-weight: 700; color: var(--white);
      letter-spacing: -0.04em; line-height: 1;
    }

    .price-cur { font-size: 0.9375rem; font-weight: 400; color: var(--g6); }

    .price-desc {
      margin-top: 8px;
      font-size: 0.8125rem; font-weight: 400; color: var(--g6);
    }

    /* Change */
    .change {
      display: inline-flex; align-items: center; gap: 6px;
      margin-top: 20px;
      font-size: 0.875rem; font-weight: 600;
      padding: 7px 14px; border-radius: 10px;
      letter-spacing: -0.01em;
    }

    .change.up { color: var(--green); background: var(--green-soft); }
    .change.dn { color: var(--red); background: var(--red-soft); }
    .change.fl { color: var(--g7); background: var(--g3); }

    .change-arr { font-size: 0.625rem; }

    /* Sep & Meta */
    .card-sep { height: 1px; background: var(--g3); margin: 26px 0 20px; }

    .meta { display: flex; flex-direction: column; gap: 13px; }

    .meta-row { display: flex; justify-content: space-between; align-items: center; }

    .meta-k { font-size: 0.8125rem; font-weight: 400; color: var(--g6); }

    .meta-v {
      font-size: 0.9375rem; font-weight: 600; color: var(--g9);
      letter-spacing: -0.02em;
    }

    /* Range chips */
    .ranges {
      display: grid; grid-template-columns: 1fr 1fr 1fr;
      gap: 10px; margin-top: 24px;
    }

    .chip {
      background: var(--g2); border: 1px solid var(--g3);
      border-radius: 13px; padding: 16px 10px; text-align: center;
      transition: border-color .25s ease, transform .25s ease;
    }

    .chip:hover { border-color: var(--g5); transform: translateY(-1px); }

    .chip-label {
      font-size: 0.6875rem; font-weight: 500;
      text-transform: uppercase; letter-spacing: 0.07em;
      color: var(--g6); margin-bottom: 7px;
    }

    .chip-val {
      font-size: 1rem; font-weight: 600; color: var(--g10);
      letter-spacing: -0.02em;
    }

    /* ============================================================
       STATES
       ============================================================ */
    .state-load, .state-err { padding: 60px 0; text-align: center; }

    .spinner {
      width: 24px; height: 24px;
      border: 2px solid var(--g3); border-top-color: var(--g6);
      border-radius: 50%; margin: 0 auto 16px;
      animation: spin .7s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .state-text { font-size: 0.875rem; color: var(--g6); }

    .err-text { font-size: 0.875rem; color: var(--red); opacity: .75; margin-bottom: 18px; }

    .btn {
      font-family: 'Helvetica Neue', 'Helvetica', sans-serif;
      font-size: 0.8125rem; font-weight: 600;
      color: var(--g9); background: var(--g3); border: 1px solid var(--g4);
      border-radius: 10px; padding: 10px 26px; cursor: pointer;
      transition: all .2s ease;
    }

    .btn:hover { background: var(--g4); border-color: var(--g5); color: var(--white); }

    /* ============================================================
       FOOTER
       ============================================================ */
    .footer {
      margin-top: 44px; padding-top: 24px;
      border-top: 1px solid var(--g3);
      text-align: center;
      opacity: 0; animation: rise .7s cubic-bezier(.16,1,.3,1) .24s forwards;
    }

    .footer p { font-size: 0.75rem; color: var(--g6); line-height: 1.9; }

    /* ============================================================
       ANIMATIONS
       ============================================================ */
    @keyframes rise {
      from { opacity: 0; transform: translateY(22px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .num-flash { animation: flash-num .45s ease; }
    @keyframes flash-num {
      0% { opacity: .25; transform: translateY(5px); }
      100% { opacity: 1; transform: translateY(0); }
    }

    /* ============================================================
       RESPONSIVE
       ============================================================ */
    @media (max-width: 680px) {
      .page { padding: 0 18px 56px; }
      .header { padding-top: 36px; }
      .hero { margin: 36px 0; padding: 44px 24px 40px; border-radius: 18px; }
      .hero-value { font-size: 3.25rem; }
      .hero-sub { font-size: 0.9375rem; }
      .cards { grid-template-columns: 1fr; gap: 12px; }
      .card { border-radius: 18px; }
      .card-inner { padding: 26px 24px 30px; }
      .price-num { font-size: 2.125rem; }
      .card-icon { width: 38px; height: 38px; border-radius: 11px; }
      .card-icon svg { width: 16px; height: 16px; }
      .hero-icon { width: 44px; height: 44px; border-radius: 13px; }
      .hero-icon svg { width: 20px; height: 20px; }
      .ranges { gap: 8px; }
      .chip { padding: 14px 8px; border-radius: 11px; }
    }

    @media (max-width: 400px) {
      .hero-value { font-size: 2.625rem; }
      .price-num { font-size: 1.75rem; }
      .card-inner { padding: 22px 20px 26px; }
      .hero { padding: 36px 18px 32px; }
    }
  </style>
</head>
<body>

<div class="page">

  <header class="header">
    <div class="brand">
      <div class="brand-mark">Ag</div>
      <span class="brand-text">Silver Premium</span>
    </div>
    <div class="header-time" id="clock"></div>
  </header>

  <!-- PREMIUM HERO -->
  <section class="hero" id="hero">
    <div class="hero-glow" id="hero-glow"></div>
    <div class="hero-icon" id="hero-icon">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3v18"/><path d="M5 7l7-4 7 4"/><path d="M5 7l-1 6c0 1.66 1.34 2 2 2h0c.66 0 2-.34 2-2L7 7"/><path d="M17 7l-1 6c0 1.66 1.34 2 2 2h0c.66 0 2-.34 2-2l-1-6"/></svg>
    </div>
    <div class="hero-label">Premium Shanghai</div>
    <div class="hero-value nil" id="h-pct">--%</div>
    <div class="hero-sub" id="h-usd">Carregando dados...</div>
    <div class="hero-note" id="h-note">SGE Ag(T+D) em relacao ao COMEX XAG/USD</div>
  </section>

  <!-- CARDS -->
  <div class="cards">

    <!-- SGE -->
    <div class="card">
      <div class="card-inner">
        <div class="card-top">
          <div class="card-id">
            <div class="card-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 21h18"/><path d="M5 21V7l7-4 7 4v14"/><path d="M9 21v-4h6v4"/><path d="M9 13h6"/><path d="M9 9h6"/></svg>
            </div>
            <div>
              <div class="card-title">Shanghai SGE</div>
              <div class="card-subtitle">Ag(T+D)</div>
            </div>
          </div>
          <div class="badge badge-delayed"><span class="badge-dot"></span>Delayed</div>
        </div>
        <div id="sge-body">
          <div class="state-load"><div class="spinner"></div><div class="state-text">Buscando dados SGE</div></div>
        </div>
      </div>
    </div>

    <!-- COMEX -->
    <div class="card">
      <div class="card-inner">
        <div class="card-top">
          <div class="card-id">
            <div class="card-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 20h18"/><path d="M6 16l4-6 4 4 4-8"/></svg>
            </div>
            <div>
              <div class="card-title">COMEX</div>
              <div class="card-subtitle">XAG / USD</div>
            </div>
          </div>
          <div class="badge badge-live"><span class="badge-dot"></span>Live</div>
        </div>
        <div id="comex-body">
          <div class="state-load"><div class="spinner"></div><div class="state-text">Buscando dados COMEX</div></div>
        </div>
      </div>
    </div>

  </div>

  <footer class="footer">
    <p>Dados atualizados a cada 30 segundos. Cotacoes SGE com atraso. Taxa de cambio USD/CNY.</p>
  </footer>

</div>

<script>
const API = '/api/prices';
const POLL = 30000;

const fmt = (v, d=2) => v.toLocaleString('pt-BR', { minimumFractionDigits: d, maximumFractionDigits: d });
const fmtUS = (v, d=2) => v.toLocaleString('en-US', { minimumFractionDigits: d, maximumFractionDigits: d });

function flash(el) {
  if (!el) return;
  el.classList.remove('num-flash');
  void el.offsetWidth;
  el.classList.add('num-flash');
}

function updateClock() {
  const now = new Date();
  document.getElementById('clock').textContent = now.toLocaleDateString('pt-BR', {
    day: '2-digit', month: 'short', year: 'numeric',
    hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
  });
}
updateClock();
setInterval(updateClock, 1000);

function renderCOMEX(c) {
  const cls = c.changePercent > 0 ? 'up' : c.changePercent < 0 ? 'dn' : 'fl';
  const arrow = c.changePercent > 0 ? '\u25B2' : c.changePercent < 0 ? '\u25BC' : '\u2014';

  document.getElementById('comex-body').innerHTML = `
    <div class="price-row">
      <span class="price-num" id="comex-p">${fmtUS(c.price, 4)}</span>
      <span class="price-cur">USD/oz</span>
    </div>
    <div class="price-desc">por onca troy</div>
    <div class="change ${cls}">
      <span class="change-arr">${arrow}</span>
      ${fmtUS(Math.abs(c.change), 4)}&nbsp;&nbsp;&nbsp;${fmtUS(Math.abs(c.changePercent), 2)}%
    </div>
    <div class="card-sep"></div>
    <div class="meta">
      <div class="meta-row">
        <span class="meta-k">Fechamento anterior</span>
        <span class="meta-v">${fmtUS(c.prevClose, 4)}</span>
      </div>
      <div class="meta-row">
        <span class="meta-k">Atualizado</span>
        <span class="meta-v">${c.timestamp}</span>
      </div>
    </div>`;
  flash(document.getElementById('comex-p'));
}

function renderSGE(s, fx) {
  document.getElementById('sge-body').innerHTML = `
    <div class="price-row">
      <span class="price-num" id="sge-p">${fmtUS(s.usd_per_oz, 4)}</span>
      <span class="price-cur">USD/oz</span>
    </div>
    <div class="price-desc">convertido de ${fmt(s.rmb_per_kg, 0)} RMB/kg</div>
    <div class="ranges">
      <div class="chip">
        <div class="chip-label">Abertura</div>
        <div class="chip-val">${s.rmb_open ? fmt(s.rmb_open, 0) : '\u2014'}</div>
      </div>
      <div class="chip">
        <div class="chip-label">Maxima</div>
        <div class="chip-val">${s.rmb_high ? fmt(s.rmb_high, 0) : '\u2014'}</div>
      </div>
      <div class="chip">
        <div class="chip-label">Minima</div>
        <div class="chip-val">${s.rmb_low ? fmt(s.rmb_low, 0) : '\u2014'}</div>
      </div>
    </div>
    <div class="card-sep"></div>
    <div class="meta">
      <div class="meta-row">
        <span class="meta-k">RMB/kg</span>
        <span class="meta-v">${fmt(s.rmb_per_kg, 0)}</span>
      </div>
      <div class="meta-row">
        <span class="meta-k">USD/CNY</span>
        <span class="meta-v">${fmtUS(fx.usd_cny, 4)}</span>
      </div>
    </div>`;
  flash(document.getElementById('sge-p'));
}

function renderPremium(p) {
  const el = document.getElementById('h-pct');
  const sub = document.getElementById('h-usd');
  const note = document.getElementById('h-note');
  const icon = document.getElementById('hero-icon');
  const glow = document.getElementById('hero-glow');

  const sign = p.percent >= 0 ? '+' : '';
  const cls = p.percent > 0 ? 'pos' : p.percent < 0 ? 'neg' : 'nil';

  el.className = 'hero-value ' + cls;
  el.textContent = sign + fmtUS(p.percent, 2) + '%';

  const uSign = p.usd >= 0 ? '+' : '';
  sub.innerHTML = '<strong>' + uSign + fmtUS(p.usd, 4) + '</strong> USD por onca';

  icon.classList.add('ok');

  glow.className = 'hero-glow';
  if (p.percent > 0) {
    glow.classList.add('pos');
    note.textContent = 'Prata em Shanghai opera com premio sobre o mercado internacional';
  } else if (p.percent < 0) {
    glow.classList.add('neg');
    note.textContent = 'Prata em Shanghai opera com desconto sobre o mercado internacional';
  } else {
    note.textContent = 'Precos alinhados entre Shanghai e COMEX';
  }

  flash(el);
}

function showErr(id, msg) {
  document.getElementById(id).innerHTML = `
    <div class="state-err">
      <div class="err-text">${msg}</div>
      <button class="btn" onclick="load()">Tentar novamente</button>
    </div>`;
}

function resetPremium() {
  document.getElementById('h-pct').textContent = '--%';
  document.getElementById('h-pct').className = 'hero-value nil';
  document.getElementById('h-usd').textContent = 'Aguardando dados...';
  document.getElementById('hero-glow').className = 'hero-glow';
}

let last = null;

async function load() {
  try {
    const r = await fetch(API);
    const t = await r.text();
    let d;
    try { d = JSON.parse(t); } catch { throw new Error('Resposta invalida do servidor'); }
    last = d;

    d.comex
      ? renderCOMEX(d.comex)
      : showErr('comex-body', d.errors?.find(e => e.source === 'comex')?.message || 'Indisponivel');

    d.sge && d.fx
      ? renderSGE(d.sge, d.fx)
      : showErr('sge-body', d.errors?.find(e => e.source === 'sge' || e.source === 'fx')?.message || 'Indisponivel');

    d.premium ? renderPremium(d.premium) : resetPremium();

  } catch (e) {
    if (!last) {
      showErr('sge-body', e.message);
      showErr('comex-body', e.message);
      resetPremium();
    }
  }
}

load();
setInterval(load, POLL);
</script>
</body>
</html>
